# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-nodejs-with-github-actions

name: Deploy Stag and Production Version on Push

on:
  push:
    branches: 
      - master
      - stag
      - dev

jobs:
  versioning:
    uses: ./.github/workflows/release.yml
    with:
      tag-suffix: ${{ github.head_ref || github.ref_name }}
      release-title: ${{ github.head_ref || github.ref_name }} build
    secrets: inherit

  # Second Job
  build-and-release-android:
    if:  ${{ github.head_ref != 'dev' || github.ref_name !='dev' }}
    needs: versioning
    uses: ./.github/workflows/build-android.yml
    with:
      environment: release
      publish: true
      APPCENTER_TOKEN_ANDROID: 'APPCENTER_TOKEN_ANDROID'
      ANDROID_KEYSTORE: 'ANDROID_KEYSTORE'
      ANDROID_KEYSTORE_PASSWORD: 'ANDROID_KEYSTORE_PASSWORD'
    secrets: inherit

  # Third Job
  build-and-release-ios:
    if:  ${{ github.head_ref != 'dev' || github.ref_name !='dev' }}
    needs: versioning
    uses: ./.github/workflows/build-ios.yml
    with:
      publish: true
      IOS_P12_BASE64: 'IOS_P12_BASE64'
      IOS_MOBILEPROVISION_BASE64: 'IOS_MOBILEPROVISION_BASE64'
      IOS_TEAM_ID: 'IOS_TEAM_ID'
      IOS_CERTIFICATE_PASSWORD: 'IOS_CERTIFICATE_PASSWORD'
      APPCENTER_TOKEN_IOS: 'APPCENTER_TOKEN_IOS'
    secrets: inherit
